%_cross_vendor thar
%_cross_libc gnu
%_cross_os %{_cross_vendor}-%{_cross_arch}-
%_cross_target %{_cross_arch}-%{_cross_vendor}-linux-%{_cross_libc}
%dist %{nil}

%_cross_cflags -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -fstack-clash-protection
%_cross_c_args '-O2', '-g', '-pipe', '-Wall', '-Werror=format-security', '-Wp,-D_FORTIFY_SOURCE=2', '-Wp,-D_GLIBCXX_ASSERTIONS', '-fexceptions', '-fstack-protector-strong', '-fstack-clash-protection'
%_cross_cxxflags %_cross_cflags
%_cross_ldflags -Wl,-z,relro -Wl,-z,now
%_cross_c_link_args '-Wl,-z,relro', '-Wl,-z,now'

%_cross_lib lib
%_cross_rootdir /%{_cross_target}/sys-root
%_cross_prefix %{_cross_rootdir}%{_prefix}
%_cross_exec_prefix %{_cross_rootdir}%{_exec_prefix}
%_cross_bindir %{_cross_rootdir}%{_bindir}
%_cross_sbindir %{_cross_rootdir}%{_sbindir}
%_cross_libdir %{_cross_prefix}/%{_cross_lib}
%_cross_libexecdir %{_cross_rootdir}%{_libexecdir}
%_cross_includedir %{_cross_rootdir}%{_includedir}
%_cross_sysconfdir %{_sysconfdir}
%_cross_tmpfilesdir %{_cross_rootdir}%{_tmpfilesdir}
%_cross_datadir %{_cross_rootdir}%{_datadir}
%_cross_datarootdir %{_cross_rootdir}%{_datarootdir}
%_cross_docdir %{_cross_datarootdir}/doc
%_cross_factorydir %{_cross_datarootdir}/factory
%_cross_localedir %{_cross_datarootdir}/locale
%_cross_infodir %{_cross_rootdir}%{_infodir}
%_cross_mandir %{_cross_rootdir}%{_mandir}
%_cross_sharedstatedir %{_sharedstatedir}
%_cross_localstatedir %{_localstatedir}
%_cross_bashdir %{_cross_datadir}/bash-completion
%_cross_pkgconfigdir %{_cross_libdir}/pkgconfig
%_cross_unitdir %{_cross_rootdir}%{_unitdir}
%_cross_userunitdir %{_cross_rootdir}%{_userunitdir}
%_cross_journalcatalogdir %{_cross_rootdir}%{_journalcatalogdir}
%_cross_sysusersdir %{_cross_rootdir}%{_sysusersdir}

%set_cross_build_flags \
  CFLAGS="${CFLAGS:-%{_cross_cflags}}" ; export CFLAGS ; \
  CXXFLAGS="${CXXFLAGS:-%{_cross_cxxflags}}" ; export CXXFLAGS ; \
  LDFLAGS="${LDFLAGS:-%{_cross_ldflags}}" ; export LDFLAGS ; \
  PKG_CONFIG_PATH="%{_cross_pkgconfigdir}" ; export PKG_CONFIG_PATH ; \

%cross_configure \
  %set_cross_build_flags \
  %{_configure} \\\
    --host=%{_cross_target} \\\
    --target=%{_cross_target} \\\
    --build=%{_build} \\\
    --disable-dependency-tracking \\\
    --prefix=%{_cross_prefix} \\\
    --exec-prefix=%{_cross_exec_prefix} \\\
    --bindir=%{_cross_bindir} \\\
    --sbindir=%{_cross_sbindir} \\\
    --sysconfdir=%{_cross_sysconfdir} \\\
    --datadir=%{_cross_datadir} \\\
    --includedir=%{_cross_includedir} \\\
    --libdir=%{_cross_libdir} \\\
    --libexecdir=%{_cross_libexecdir} \\\
    --localstatedir=%{_cross_localstatedir} \\\
    --sharedstatedir=%{_cross_sharedstatedir} \\\
    --mandir=%{_cross_mandir} \\\
    --infodir=%{_cross_infodir}

%_cross_vpath_srcdir .
%_cross_vpath_builddir %_cross_target
%_cross_compilation_conf %{_cross_vpath_srcdir}/cross-compilation.conf

%write_cross_compilation_conf \
cat <<CROSS_COMPILATION_CONF_EOF >%_cross_compilation_conf 2>/dev/null || :\
[binaries]\
c = '%{_cross_target}-gcc'\
cpp = '%{_cross_target}-g++'\
ar = '%{_cross_target}-ar'\
strip = '%{_cross_target}-strip'\
pkgconfig = '/usr/bin/pkg-config'\
[properties]\
c_args = [%{_cross_c_args}]\
c_link_args = [%{_cross_c_link_args}]\
[host_machine]\
system = 'linux'\
cpu_family ='%{_cross_cpu_family}'\
cpu = '%{_cross_arch}'\
endian = '%{_cross_endian}'\
CROSS_COMPILATION_CONF_EOF\
%{nil}

%cross_meson \
  %write_cross_compilation_conf \
  %set_cross_build_flags \
  %{shrink:%{__meson} \
    --buildtype=plain \
    --default-library=shared \
    --cross-file=%{_cross_compilation_conf} \
    --prefix=%{_cross_prefix} \
    --libdir=%{_cross_libdir} \
    --libexecdir=%{_cross_libexecdir} \
    --bindir=%{_cross_bindir} \
    --sbindir=%{_cross_sbindir} \
    --includedir=%{_cross_includedir} \
    --datadir=%{_cross_datadir} \
    --mandir=%{_cross_mandir} \
    --infodir=%{_cross_infodir} \
    --localedir=%{_cross_localedir} \
    --sysconfdir=%{_cross_sysconfdir} \
    --localstatedir=%{_cross_localstatedir} \
    --sharedstatedir=%{_cross_sharedstatedir} \
    --wrap-mode=%{__meson_wrap_mode} \
    --auto-features=%{__meson_auto_features} \
    %{_cross_vpath_srcdir} %{_cross_vpath_builddir} \
    %{nil}}

%cross_meson_build \
  %ninja_build -C %{_cross_vpath_builddir}

%cross_meson_install \
  %ninja_install -C %{_cross_vpath_builddir}

%__nm %{_bindir}/%{_cross_target}-nm
%__objcopy %{_bindir}/%{_cross_target}-objcopy
%__objdump %{_bindir}/%{_cross_target}-objdump
%__strip %{_bindir}/%{_cross_target}-strip

# Prevent RPM from erroring out the build when it detects our cross-compiled
# artifacts.
%_binaries_in_noarch_packages_terminate_build 0

# Prevent RPM from detecting provides or requires for any files.
%__requires_exclude ^.*$
%__provides_exclude ^.*$

# Do not generate build ID links in main packages.
%_build_id_links alldebug

# Do not run ldconfig after build.
%__brp_ldconfig %{nil}
